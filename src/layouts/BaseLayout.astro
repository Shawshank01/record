---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import '../styles/global.css';
import searchScript from '../scripts/search.js?url';
import { headerSubtitleOptions } from '../data/subtitles';

const {
  pageTitle = "Michifumi's Blog",
  description = "Dispatches from Michifumi's command chair.",
  searchPayload
} = Astro.props;

const searchPayloadString = searchPayload
  ? JSON.stringify(searchPayload)
      .replace(/</g, '\\u003c')
      .replace(/&/g, '\\u0026')
  : undefined;
---
<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <title>{pageTitle}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/svg+xml" href="/icon.svg" />
    <link rel="alternate icon" href="/icon.svg" />
  </head>
  <body class="bg-surface text-gray-100">
    <Header
      title="Michifumi's Blog"
      subtitleOptions={headerSubtitleOptions}
    />
    <main
      class="mx-auto flex min-h-screen max-w-6xl flex-col gap-10 px-4 pb-16 md:flex-row md:px-6"
      style="padding-top: calc(var(--header-offset, 8rem) + 2rem);"
    >
      <slot />
    </main>
    <Footer />
    {
      searchPayloadString && (
        <Fragment>
          <script type="application/json" id="search-data" set:html={searchPayloadString}></script>
          <script is:inline type="module">
            const dataTag = document.getElementById('search-data');
            const searchInput = document.getElementById('blog-search');
            if (dataTag && searchInput) {
              window.__MICHIFUMI_POSTS__ = JSON.parse(dataTag.textContent || '[]');
            }

            const headerEl = document.querySelector('[data-site-header]');
            const applyOffset = () => {
              if (!headerEl) return;
              const height = headerEl.getBoundingClientRect().height;
              document.documentElement.style.setProperty('--header-offset', `${height}px`);
            };

            if (headerEl) {
              applyOffset();
              if (typeof ResizeObserver !== 'undefined') {
                const observer = new ResizeObserver(() => applyOffset());
                observer.observe(headerEl);
              }
            }

            window.addEventListener('resize', applyOffset, { passive: true });
          </script>
          <script type="module" src={searchScript}></script>
        </Fragment>
      )
    }
    <slot name="scripts" />
    <script is:inline>
      const anchors = document.querySelectorAll('a[href^="http"]');
      anchors.forEach((anchor) => {
        const url = new URL(anchor.href, window.location.origin);
        const isExternal = url.hostname !== window.location.hostname;
        if (isExternal) {
          anchor.setAttribute('target', '_blank');
          anchor.setAttribute('rel', anchor.getAttribute('rel') ? anchor.getAttribute('rel') : 'noopener');
        }
      });
    </script>
    <script is:inline>
      (() => {
        if (typeof window === 'undefined') return;

        const copyText = async (text) => {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            return true;
          }

          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.setAttribute('readonly', '');
          textarea.style.position = 'absolute';
          textarea.style.left = '-9999px';
          textarea.style.top = '0';
          document.body.appendChild(textarea);
          textarea.select();

          try {
            return document.execCommand('copy');
          } catch {
            return false;
          } finally {
            document.body.removeChild(textarea);
          }
        };

        const blocks = document.querySelectorAll('pre');
        blocks.forEach((pre) => {
          if (pre.querySelector('.code-copy-button')) return;
          const code = pre.querySelector('code');
          if (!code) return;

          const copyIcon = `
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <rect x="9" y="9" width="10" height="10" rx="2"></rect>
              <path d="M5 15V7a2 2 0 0 1 2-2h8"></path>
            </svg>
          `;
          const checkIcon = `
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M5 13l4 4L19 7"></path>
            </svg>
          `;
          const failIcon = `
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M6 6l12 12M18 6L6 18"></path>
            </svg>
          `;

          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'code-copy-button';
          button.innerHTML = copyIcon;
          button.setAttribute('aria-label', 'Copy code to clipboard');
          button.setAttribute('title', 'Copy');

          const setState = (state) => {
            if (state === 'copied') {
              button.innerHTML = checkIcon;
              button.dataset.copied = 'true';
              button.setAttribute('aria-label', 'Copied');
              button.setAttribute('title', 'Copied');
              return;
            }

            if (state === 'failed') {
              button.innerHTML = failIcon;
              button.dataset.copied = 'false';
              button.setAttribute('aria-label', 'Copy failed');
              button.setAttribute('title', 'Copy failed');
              return;
            }

            button.innerHTML = copyIcon;
            button.dataset.copied = 'false';
            button.setAttribute('aria-label', 'Copy code to clipboard');
            button.setAttribute('title', 'Copy');
          };

          let resetTimer;
          button.addEventListener('click', async () => {
            const text = code.textContent || '';
            const ok = await copyText(text);

            setState(ok ? 'copied' : 'failed');

            window.clearTimeout(resetTimer);
            resetTimer = window.setTimeout(() => setState('idle'), 2000);
          });

          pre.appendChild(button);
        });
      })();
    </script>
    <script is:inline>
  (() => {
    if (typeof window === 'undefined' || typeof navigator === 'undefined') return;

    const endpoint = 'https://stats.zaku.eu.org/track';
    const payload = JSON.stringify({
      path: window.location.pathname,
      referrer: document.referrer || '',
      ua: navigator.userAgent
    });

    try {
      if (navigator.sendBeacon) {
        const blob = new Blob([payload], { type: 'application/json' });
        const ok = navigator.sendBeacon(endpoint, blob);
        if (ok) return;
      }
      fetch(endpoint, {
        method: 'POST',
        body: payload,
        keepalive: true,
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' }
      }).catch(err => console.warn('[analytics] fetch failed', err));
    } catch (err) {
      console.warn('[analytics] unexpected error', err);
    }
  })();
</script>
  </body>
</html>
