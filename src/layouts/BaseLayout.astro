---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import '../styles/global.css';
import searchScript from '../scripts/search.ts?url';
import { headerSubtitleOptions } from '../data/subtitles';

const {
  site = 'https://zaku.eu.org',
  pageTitle = "Michifumi's Blog",
  description = "Dispatches from Michifumi's command chair.",
  searchPayload,
  image = '/icon.svg',
  article
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const socialImageURL = new URL(image, Astro.url);

const searchPayloadString = searchPayload
  ? JSON.stringify(searchPayload)
      .replace(/</g, '\\u003c')
      .replace(/&/g, '\\u0026')
  : undefined;

const jsonLd = article ? JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: article.title,
  description: article.description,
  datePublished: article.pubDate.toISOString(),
  ...(article.updateDate ? { dateModified: article.updateDate.toISOString() } : {}),
  url: canonicalURL.href,
  image: socialImageURL.href,
  author: {
    '@type': 'Person',
    name: 'Michifumi',
    url: site
  },
  publisher: {
    '@type': 'Person',
    name: 'Michifumi',
    url: site
  },
  ...(article.tags?.length ? { keywords: article.tags.join(', ') } : {})
}) : undefined;
---
<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self' https://stats.zaku.eu.org; base-uri 'self'; form-action 'self';" />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={socialImageURL} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={Astro.url} />
    <meta property="twitter:title" content={pageTitle} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={socialImageURL} />

    <title>{pageTitle}</title>
    {jsonLd && (
      <script type="application/ld+json" set:html={jsonLd} />
    )}
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="sitemap" href="/sitemap.xml" />
    <link rel="alternate" type="application/rss+xml" title="Michifumi's Blog" href={`${Astro.site}rss.xml`} />
    <link rel="icon" type="image/svg+xml" href="/icon.svg" />
    <link rel="alternate icon" href="/icon.svg" />
  </head>
  <body class="bg-surface text-gray-100">
    <Header
      title="Michifumi's Blog"
      subtitleOptions={headerSubtitleOptions}
    />
    <main
      class="mx-auto flex min-h-screen max-w-6xl flex-col gap-10 px-4 pb-16 md:flex-row md:px-6"
      style="padding-top: calc(var(--header-offset, 8rem) + 2rem);"
    >
      <slot />
    </main>
    <Footer />
    <button
      type="button"
      class="fixed bottom-6 right-6 z-40 flex h-12 w-12 items-center justify-center rounded-full border border-white/10 bg-soft/90 text-gray-100 shadow-soft transition hover:border-accent/60 hover:text-accent/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent/60 opacity-0 pointer-events-none translate-y-2"
      data-back-to-top
      aria-label="Back to top"
      title="Back to top"
    >
      <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 5l-6 6m6-6l6 6M12 5v14" />
      </svg>
    </button>
    {
      searchPayloadString && (
        <Fragment>
          <script type="application/json" id="search-data" set:html={searchPayloadString}></script>
          <script is:inline type="module">
            const dataTag = document.getElementById('search-data');
            const searchInput = document.getElementById('blog-search');
            if (dataTag && searchInput) {
              window.__MICHIFUMI_POSTS__ = JSON.parse(dataTag.textContent || '[]');
            }

            const headerEl = document.querySelector('[data-site-header]');
            const applyOffset = () => {
              if (!headerEl) return;
              const height = headerEl.getBoundingClientRect().height;
              document.documentElement.style.setProperty('--header-offset', `${height}px`);
            };

            if (headerEl) {
              applyOffset();
              if (typeof ResizeObserver !== 'undefined') {
                const observer = new ResizeObserver(() => applyOffset());
                observer.observe(headerEl);
              }
            }

            window.addEventListener('resize', applyOffset, { passive: true });
          </script>
          <script type="module" src={searchScript}></script>
        </Fragment>
      )
    }
    <slot name="scripts" />
    <script src="../scripts/external-links.ts"></script>
    <script src="../scripts/back-to-top.ts"></script>
    <script src="../scripts/code-copy.ts"></script>
    <script src="../scripts/analytics.ts"></script>
    <script src="../scripts/lightbox.ts"></script>
    <script src="../scripts/lang-switcher.ts"></script>
  </body>
</html>
