---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import '../styles/global.css';
import searchScript from '../scripts/search.js?url';
import { headerSubtitleOptions } from '../data/subtitles';

const {
  site = 'https://zaku.eu.org',
  pageTitle = "Michifumi's Blog",
  description = "Dispatches from Michifumi's command chair.",
  searchPayload,
  image = '/icon.svg'
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const socialImageURL = new URL(image, Astro.url);

const searchPayloadString = searchPayload
  ? JSON.stringify(searchPayload)
      .replace(/</g, '\\u003c')
      .replace(/&/g, '\\u0026')
  : undefined;
---
<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self' https://stats.zaku.eu.org:8443;" />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={socialImageURL} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={Astro.url} />
    <meta property="twitter:title" content={pageTitle} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={socialImageURL} />

    <title>{pageTitle}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <link rel="alternate" type="application/rss+xml" title="Michifumi's Blog" href={`${Astro.site}rss.xml`} />
    <link rel="icon" type="image/svg+xml" href="/icon.svg" />
    <link rel="alternate icon" href="/icon.svg" />
  </head>
  <body class="bg-surface text-gray-100">
    <Header
      title="Michifumi's Blog"
      subtitleOptions={headerSubtitleOptions}
    />
    <main
      class="mx-auto flex min-h-screen max-w-6xl flex-col gap-10 px-4 pb-16 md:flex-row md:px-6"
      style="padding-top: calc(var(--header-offset, 8rem) + 2rem);"
    >
      <slot />
    </main>
    <Footer />
    <button
      type="button"
      class="fixed bottom-6 right-6 z-40 flex h-12 w-12 items-center justify-center rounded-full border border-white/10 bg-soft/90 text-gray-100 shadow-soft transition hover:border-accent/60 hover:text-accent/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent/60 opacity-0 pointer-events-none translate-y-2"
      data-back-to-top
      aria-label="Back to top"
      title="Back to top"
    >
      <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 5l-6 6m6-6l6 6M12 5v14" />
      </svg>
    </button>
    {
      searchPayloadString && (
        <Fragment>
          <script type="application/json" id="search-data" set:html={searchPayloadString}></script>
          <script is:inline type="module">
            const dataTag = document.getElementById('search-data');
            const searchInput = document.getElementById('blog-search');
            if (dataTag && searchInput) {
              window.__MICHIFUMI_POSTS__ = JSON.parse(dataTag.textContent || '[]');
            }

            const headerEl = document.querySelector('[data-site-header]');
            const applyOffset = () => {
              if (!headerEl) return;
              const height = headerEl.getBoundingClientRect().height;
              document.documentElement.style.setProperty('--header-offset', `${height}px`);
            };

            if (headerEl) {
              applyOffset();
              if (typeof ResizeObserver !== 'undefined') {
                const observer = new ResizeObserver(() => applyOffset());
                observer.observe(headerEl);
              }
            }

            window.addEventListener('resize', applyOffset, { passive: true });
          </script>
          <script type="module" src={searchScript}></script>
        </Fragment>
      )
    }
    <slot name="scripts" />
    <script is:inline>
      const anchors = document.querySelectorAll('a[href^="http"]');
      anchors.forEach((anchor) => {
        const url = new URL(anchor.href, window.location.origin);
        const isExternal = url.hostname !== window.location.hostname;
        if (isExternal) {
          anchor.setAttribute('target', '_blank');
          anchor.setAttribute('rel', anchor.getAttribute('rel') ? anchor.getAttribute('rel') : 'noopener');
        }
      });
    </script>
    <script is:inline>
      (() => {
        const button = document.querySelector('[data-back-to-top]');
        if (!button) return;

        const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        const update = () => {
          const show = window.scrollY > 0;
          button.classList.toggle('opacity-0', !show);
          button.classList.toggle('pointer-events-none', !show);
          button.classList.toggle('translate-y-2', !show);
        };

        button.addEventListener('click', () => {
          window.scrollTo({ top: 0, behavior: prefersReduced ? 'auto' : 'smooth' });
        });

        let ticking = false;
        window.addEventListener('scroll', () => {
          if (!ticking) {
            window.requestAnimationFrame(() => {
              update();
              ticking = false;
            });
            ticking = true;
          }
        }, { passive: true });

        update();
      })();
    </script>
    <script is:inline>
      (() => {
        if (typeof window === 'undefined') return;

        const copyText = async (text) => {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            return true;
          }

          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.setAttribute('readonly', '');
          textarea.style.position = 'absolute';
          textarea.style.left = '-9999px';
          textarea.style.top = '0';
          document.body.appendChild(textarea);
          textarea.select();

          try {
            return document.execCommand('copy');
          } catch {
            return false;
          } finally {
            document.body.removeChild(textarea);
          }
        };

        const blocks = document.querySelectorAll('pre');
        blocks.forEach((pre) => {
          const code = pre.querySelector('code');
          if (!code) return;

          let wrapper = pre.parentElement;
          if (!wrapper || !wrapper.classList.contains('code-block')) {
            wrapper = document.createElement('div');
            wrapper.className = 'code-block';
            pre.parentNode?.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);
          }

          if (wrapper.querySelector('.code-copy-button')) return;

          const copyIcon = `
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <rect x="9" y="9" width="10" height="10" rx="2"></rect>
              <path d="M5 15V7a2 2 0 0 1 2-2h8"></path>
            </svg>
          `;
          const checkIcon = `
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M5 13l4 4L19 7"></path>
            </svg>
          `;
          const failIcon = `
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M6 6l12 12M18 6L6 18"></path>
            </svg>
          `;

          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'code-copy-button';
          button.innerHTML = copyIcon;
          button.setAttribute('aria-label', 'Copy code to clipboard');
          button.setAttribute('title', 'Copy');

          const setState = (state) => {
            if (state === 'copied') {
              button.innerHTML = checkIcon;
              button.dataset.copied = 'true';
              button.setAttribute('aria-label', 'Copied');
              button.setAttribute('title', 'Copied');
              return;
            }

            if (state === 'failed') {
              button.innerHTML = failIcon;
              button.dataset.copied = 'false';
              button.setAttribute('aria-label', 'Copy failed');
              button.setAttribute('title', 'Copy failed');
              return;
            }

            button.innerHTML = copyIcon;
            button.dataset.copied = 'false';
            button.setAttribute('aria-label', 'Copy code to clipboard');
            button.setAttribute('title', 'Copy');
          };

          let resetTimer;
          button.addEventListener('click', async () => {
            const text = code.textContent || '';
            const ok = await copyText(text);

            setState(ok ? 'copied' : 'failed');

            window.clearTimeout(resetTimer);
            resetTimer = window.setTimeout(() => setState('idle'), 2000);
          });

          wrapper.appendChild(button);
        });
      })();
    </script>
    <script is:inline>
  (() => {
    if (typeof window === 'undefined' || typeof navigator === 'undefined') return;

    const endpoint = 'https://stats.zaku.eu.org:8443/track';
    const payload = JSON.stringify({
      path: window.location.pathname,
      referrer: document.referrer || ''
    });

    try {
      if (navigator.sendBeacon) {
        const blob = new Blob([payload], { type: 'text/plain' });
        const ok = navigator.sendBeacon(endpoint, blob);
        if (ok) return;
      }
      fetch(endpoint, {
        method: 'POST',
        body: payload,
        keepalive: true,
        mode: 'no-cors',
        headers: { 'Content-Type': 'text/plain' }
      }).catch(err => console.warn('[analytics] fetch failed', err));
    } catch (err) {
      console.warn('[analytics] unexpected error', err);
    }
  })();
</script>
  </body>
</html>
