---
import BaseLayout from '../../layouts/BaseLayout.astro';
import TagSidebar from '../../components/TagSidebar.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const allPosts = (await getCollection('blog', ({ data }) => !data.draft)).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const tagAccumulator = allPosts.reduce(
  (acc, entry) => {
    entry.data.tags.forEach((tag) => {
      const normalized = tag.toLowerCase();
      const existing = acc.get(normalized);
      if (existing) {
        existing.count += 1;
      } else {
        acc.set(normalized, { label: tag, count: 1 });
      }
    });
    return acc;
  },
  new Map<string, { label: string; count: number }>()
);

const sidebarTags = Array.from(tagAccumulator.entries())
  .sort(([, a], [, b]) => a.label.localeCompare(b.label))
  .map(([normalized, { label, count }]) => ({ normalized, label, count }));

const totalPosts = allPosts.length;

const searchPayload = allPosts.map((entry) => ({
  id: entry.id,
  slug: entry.slug,
  title: entry.data.title,
  description: entry.data.description,
  pubDate: entry.data.pubDate,
  tags: entry.data.tags,
  body: entry.body
}));

---
<BaseLayout
  pageTitle={`${post.data.title} Â· Michifumi's Blog`}
  description={post.data.description}
  searchPayload={searchPayload}
>
  <TagSidebar tags={sidebarTags} allCount={totalPosts} />
  <article class="prose prose-invert prose-headings:tracking-tight max-w-none flex-1 space-y-6">
    <header class="rounded-3xl border border-white/5 bg-soft/70 p-8 shadow-soft">
      <p class="text-xs uppercase tracking-[0.3em] text-gray-500">
        {new Date(post.data.pubDate).toLocaleDateString(undefined, {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        })}
      </p>
      <h1 class="mt-4 text-3xl font-bold text-white md:text-4xl">{post.data.title}</h1>
      <p class="mt-3 max-w-2xl text-base text-gray-300">{post.data.description}</p>
      <div class="mt-4 flex flex-wrap gap-2">
        {post.data.tags.map((tag) => (
          <span class="rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs font-medium text-gray-200">
            #{tag}
          </span>
        ))}
      </div>
    </header>
    <section class="rounded-3xl border border-white/5 bg-soft/70 p-8 shadow-soft text-base leading-relaxed text-gray-200">
      <Content />
    </section>
  </article>
</BaseLayout>
